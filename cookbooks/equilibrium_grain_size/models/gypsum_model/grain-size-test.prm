# This is a copy of the grain size strain test. The test imposes simple shear
# across a 100 km square domain with a rheology derived from experiments on
# olivine. The model domain is isobaric and initially isothermal.
# The addinital named output prescribed_field_output_C0 represents the
# equilibrium grain size, which should be close to 9.35850647e-04 m
# (the value from the grain size strain test).


set Additional shared libraries            = ../../plugins/libequilibrium_grain_size.so

set Dimension                              = 2
set Use years in output instead of seconds = true
set Start time                             = 0
set End time                               = 0
set Nonlinear solver scheme                = no Advection, iterated Stokes
set Max nonlinear iterations               = 5
set Adiabatic surface temperature          = 1600.0
set Output directory                       = grain-size-test

subsection Solver parameters
  subsection Stokes solver parameters
    set Linear solver tolerance = 1e-4
    set Number of cheap Stokes solver steps = 2000
    set GMRES solver restart length = 200
    set Maximum number of expensive Stokes solver steps = 200
    set Use full A block as preconditioner = true
  end
end


subsection Compositional fields
  set Number of fields = 2
  set Names of fields = grain_size, vs_anomaly
  set Compositional field methods = prescribed field, static
end


subsection Initial composition model
  set List of model names = function

  subsection Function
    set Function expression = 0.001;0
  end
end


subsection Heating model
  set List of model names = adiabatic heating, shear heating
end


subsection Material model
  set Model name = equilibrium grain size

  subsection Equilibrium grain size model
    set Reference density                = 3400
    set Thermal conductivity             = 0
    set Thermal expansion coefficient    = 0
    set Reference compressibility        = 0
    set Viscosity                        = 1e18
    set Minimum viscosity                = 1e10
    set Maximum viscosity                = 1e30
    set Reference temperature            = 1600
    set Minimum grain size               = 1e-6

    set Grain growth activation energy       = 4e5
    set Grain growth activation volume       = 0.0
    set Grain growth rate constant           = 1.92E-010
    set Grain growth exponent                = 3
    set Average specific grain boundary energy = 1.0
    set Work fraction for boundary area change = 0.1
    set Geometric constant                   = 3
    set Use paleowattmeter                          = true
    set Reciprocal required strain                  = 10

    # Faul and Jackson 2007
    # Diffusion creep
    # new scaled prefactors to match vertical viscosity profile
    set Diffusion creep prefactor            =3.0e-015 # s^-1 Pa^-1 m^p
    set Diffusion creep exponent             =1.0 # 1 for diffusion creep
    set Diffusion creep grain size exponent  =3
    set Diffusion activation energy          =3.75e5 #J/mol
    set Diffusion activation volume          =6e-6 # m^3/mol (from Karato 2010)

    set Dislocation viscosity iteration threshold = 1e-4
    # Kawazoe et al. (2009)
    # Dislocation creep
    set Dislocation creep prefactor          =1.244507e-15 # s^-1 Pa^-n
    set Dislocation creep exponent           =3.5
    set Dislocation activation energy        =530000 # J/mol
    set Dislocation activation volume        =1.40E-005 # m^3/mol

    subsection Crustal depths
      set Data directory                            = ../../input_data/
      set Data file name                            = crust_2D_zero_thickness.txt
    end

  end
end


subsection Geometry model
  set Model name = box

  subsection Box
    set X extent  = 100000
    set Y extent  = 100000
    set X periodic= true
  end
end


subsection Boundary velocity model
   set Prescribed velocity boundary indicators = top:function, bottom:function

  subsection Function
    set Function expression = if(y>50000,1,0);0
  end
end



subsection Boundary temperature model
  set Fixed temperature boundary indicators   = top, bottom
  set List of model names = box
  subsection Box
    set Top temperature = 1600
    set Bottom temperature = 1600
  end
end


subsection Initial temperature model
  set List of model names = function, adiabatic boundary

  subsection Function
    set Function expression = 1600
  end

  subsection Adiabatic boundary
    set Data directory = ../../input_data/
    set Data file name = crust_2D_zero_thickness.txt
    set Adiabatic temperature gradient = 0
    set Isotherm temperature = 0
    set Surface temperature = 0
  end
end


subsection Gravity model
  set Model name = vertical
  subsection Vertical
    set Magnitude = 0.0
  end
end


subsection Mesh refinement
  set Initial global refinement          = 3
  set Initial adaptive refinement        = 0
  set Strategy                           = temperature
  set Time steps between mesh refinement = 0
end

subsection Postprocess
  set List of postprocessors = velocity statistics, visualization, Stokes residual, heat flux statistics, memory statistics

  subsection Visualization
    set Output format                 = vtu
    set List of output variables      = material properties, strain rate, named additional outputs
    set Time between graphical output = 0
    set Number of grouped files       = 1

# We only have dirichlet boundaries with tangential velocities, so we can
# increase the output resolution as described in the documentation of the 'heat
# flux map' postprocessor.
    subsection Heat flux map
      set Output point wise heat flux = true
    end
  end

  subsection Geoid
    set Also output the gravity anomaly  = true
  end
end
